# 债务螺旋模型代码说明与调用指南

本目录包含多个版本的债务螺旋推演脚本与说明材料。本文档概述各文件的差异、适用场景以及如何运行。

## 文件总览

- `ds_v1.py`：早期基础版，参数与逻辑较为简化，便于快速演示核心思路。
- `ds_v2.py`：增强版，使用 Streamlit 可视化，包含更长推演周期（代码中可见“✅ 幸存: 36 Months”提示），交互更完善。
- `ds_v6.py`：迭代版，通常包含更完整的规则集、边界处理与图表交互（适合业务讨论与方案验证）。
- `客户债务螺旋死亡模型介绍v0.1.html`：早期概念阐释材料（静态HTML）。
- `客户债务螺旋死亡模型介绍v4.html`：更新版阐释材料（静态HTML），结构与内容更丰富，适合汇报。
- `2个客户贷款明细.csv`：示例数据文件（用于演示或验证）。

> 注：若目录内存在 `debt_spiral_app.py`，其通常是“资方上限版”的 Streamlit 应用，新增“市场机构数量上限”“续贷/过桥”等行为模拟，并做了空数据防御与图表交互优化。

## 版本差异与适用性

- `ds_v1.py`
  - 侧重核心现金流与负债演化的最小可运行模型。
  - 参数较少、边界处理简化，便于快速测试或教学。
- `ds_v2.py`
  - 引入更长推演窗口（36个月提示），并通过 Streamlit 实现可视化与交互。
  - 更丰富的指标展示与状态提示（如“幸存/违约”）。
- `ds_v6.py`
  - 在 v2 基础上扩展行为规则（如分层资方、到期滚动、续贷限制等）。
  - 更关注业务边界与鲁棒性，适合和风控、产品进行方案评审。


## 环境与依赖

- Python 3.8+
- 依赖：`streamlit`, `pandas`, `altair`
- 安装：
  - `pip install streamlit pandas altair`

## 运行指南

- 运行 Streamlit 应用（推荐 v2/v6）：
  - `streamlit run ds_v2.py`
  - 或 `streamlit run ds_v6.py`

- 打开浏览器，按页面左侧参数配置后，点击“开始推演”。

## 常见参数说明（示例）

- 客户画像：月收入、初始存款、基本生活费、固定支出。
- 市场规则：分层资方的“机构上限数量”“额度倍数/固定额度”“年化利率”。
- 存量债务：各层当前余额与到期月份（影响续贷与过桥行为）。

## 输出与可视化

- 摘要指标：最终总负债、违约月份/幸存提示、额度耗尽率等。
- 图表：
  - 债务结构演化（分层面积图）。
  - 市场容量监测（总负债 vs 总额度上限，并标注借新还旧时刻）。
- 明细表：逐月记录（总负债、分层负债、是否发生滚动/续贷事件等）。

## 故障排查

- `TypeError: cannot unpack non-iterable NoneType object`
  - 原因：推演函数未返回期望的 `(df, fail_month, limits)` 三元组或返回 `None`。
  - 处理：确保 `run_simulation()` 所有分支都显式返回三元组；对空 `df` 做 UI 防御（先判断 `df.empty` 再绘图/展示）。
- Streamlit 容器宽度警告
  - 提示：`use_container_width=True` 已弃用，改用 `width='stretch'` 或 `width='content'`。
  - 处理：在 `st.altair_chart` 或图表属性中采用新参数写法。

## 推荐实践

- 将核心计算与可视化解耦：把推演引擎封装为纯函数，UI 只负责展示与防御。
- 强化边界处理：
  - 开局即破产的空数据提示；
  - 月末/到期滚动的续贷限制；
  - 分层额度与利率的一致性校验。
- 汇报材料：优先使用 `客户债务螺旋死亡模型介绍v4.html` 做背景与场景说明，结合 v6 的交互展示效果。

## 目录内示例数据使用

- `2个客户贷款明细.csv` 可用于演示数据加载流程或与仿真结果进行直观对比。
- 如需接入真实数据，请统一字段命名与日期格式，避免运行期类型错误。

---
如需对某个版本的行为规则、指标口径（如“滚动/过桥定义”“违约判定”等）进行细化，我可以在现有脚本上继续迭代并补充单元测试与DQ校验脚本。
